<html>
  <head>
    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <script src="//code.jquery.com/jquery-1.11.0.min.js"></script>
    <link href='http://fonts.googleapis.com/css?family=Libre+Baskerville' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
    <style type="text/css">

      .axis path,
      .axis line {
        fill:none;
        stroke:black;
      }
      .axis text {
        font-family: sans-serif;
        font-size: 11px;
      }
      h1{
        font-family: 'Libre Baskerville', serif;
        text-align: center;
      }
      h2{
        color: #888;
        font-family: 'Libre Baskerville', serif;
        text-align: center;
      }
      body{
        text-align: center;
      }
      span.glyphicon{
        font-size: 30px;
        margin-right: 20px;
        margin-left: 20px;
      }
      .btn-bar{
        margin-top: 50px;
      }

  </style>
  </head>
  <body>
    <script type="text/javascript">

    //define global variables
    var canvasWidth = 550;
    var canvasHeight = 250;
    var xPad = 50;
    var yPad = 50;
    var counter = 24; //initialized to have 2 years of returns in past
    var speed = 500;
    var binNum = 7;
    var running = true;
    var bars;
    var renderPoint;

    //define menu button functions
    var pause = function(){
      running = false;
    }
    var speedUp = function(){
      if (speed > 100){
        speed -= 100;
      }
    }
    var slowDown = function(){
      if (speed < 1000){
        speed += 100
      }
    }
    var play = function(){
      pause();
      bars.remove();
      running = true;
      renderPoint(counter);
    }

      d3.csv('/resources/S&P.csv', function(file){


      // set parameters for canvas and axes
      var heightScale = d3.scale.linear()
                        .domain([24,0])
                        .range([0,canvasHeight - yPad]);

      var widthScale = d3.scale.linear()
                      .domain([-0.3, 0.7])
                      .range([0,canvasWidth - xPad]);

      var xAxis = d3.svg.axis()
                  .scale(widthScale)
                  .orient('bottom');

      var yAxis = d3.svg.axis()
                  .scale(heightScale)
                  .orient('left');

      var canvas = d3.select('body').append('svg')
          .attr('width', canvasWidth)
          .attr('class', 'axis')
          .attr('height', 500);

      var xLabel = canvas.append("text")
                  .attr("class", "x label")
                  .attr("text-anchor", "end")
                  .attr("x", 375)
                  .attr("y", 275)
                  .text("S&P 500 Percentage Returns");

      var yLabel = canvas.append("text")
                  .attr("class", "y label")
                  .attr("text-anchor", "end")
                  .attr("y", 9)
                  .attr('x', -100)
                  // .attr("dy", "100")
                  .attr("transform", "rotate(-90)")
                  .text("Frequency");

      //CANVAS TRANSLATIONS DO NOT ADJUST DYNAMICALLY
      //PADDING: 25PX ABOVE AND BELOW AXES, 50PX ON THE LEFT
      canvas.append('g')
        .attr('transform', 'translate(50,225)')
        .call(xAxis);

      canvas.append('g')
        .attr('transform', 'translate(50,25)')
        .call(yAxis);

      // define functions for use within renderPoint
      var months = ['January','February','March','April', 'May', 'June','July','August', 'September', 'October', 'November', 'December'];
      var parseDate = function(dateNum){
        dateNum = Number(dateNum.replace(',',''));
        var month = months[Math.round((Number(dateNum) % 1)/0.01) - 1];
        var year = Math.floor(Number(dateNum));
        return (month+', '+year);
      }

      var xMap = function(x){
        return (50 + (x + 0.3)*500) ;
      }

      var yMap = function(y){
        return (y*200/24);
      }

      var base = function(y){
        return (225 - yMap(y))
      }

      var getWidth = function(max, min){
        return ((xMap(max) - xMap(min))/(binNum))*(0.95)
      }

      var getColor = function(num){
        if(num < 1){
          return 'OrangeRed';
        }
        else{
          return "SteelBlue"
        }
      }

      var average = function(arr){
        if (arr.length == 0){
          return 0;
        }
        var sum = 0;
        for (var k=0; k<arr.length;k++){
          sum += arr[k];
        }
        return (sum/arr.length);
      }

      renderPoint = function(i){
        var data = [];
        var ret = 1;

        for (var j=0; j<24; j++){
          data.push(file[i-j]);
          ret = ret * (1 + Number(file[i-j]['Return']));
        }
        console.log('Return: ',ret);

      var mapFun = data.map(function(x){
        var datum = Number(x['Return'].replace(',',''));
        return datum;
      });

        var date = file[i]['Date'];
        var price = file[i]['S&P Price']

        $('h1').html(parseDate(date));
        $('h2').html(Number(price.replace(',','')).toFixed(2));


        var hist = d3.layout.histogram()
          .bins(binNum)
          (mapFun);
        //console.log('hist: '+hist);

        bars = canvas.selectAll('.bar')
          .data(hist)
          .enter()
          .append('g');

        //console.log('bars: ',bars)
        console.log(hist);
        var min = hist[0][0];
        var max = hist[binNum - 1][hist[binNum - 1].length - 1];

        bars.append('rect')
          .attr('x', function(d){return xMap(d.x);})
          .attr('y', function(d){return base(d.y)})
          .attr('width', function(d){return d.dx*500*(0.95);})
          .attr('height', function(d){return yMap(d.y);})
          .attr('fill', getColor(ret));

        //recursion for animation
        setTimeout(function(){
          if (running && (i+1 < file.length)){
            bars.remove();
            counter++;
            renderPoint(i+1);
          }
        }, speed)
      }

      // var footer = d3.select('body').append('p');
      // $('p').html('<i class="fa fa-github fl-lg">Nathan Epstein</i>')

      renderPoint(counter);

    });

    // TO DO:
    //code indentation/refactoring
    //include github info
    //

    </script>
    <div class='jumbotron'>
      <h1>January, 1873</h1>
      <h2>5.11</h2>
      <div class='btn-bar'>
        <span class='glyphicon glyphicon-pause' onclick='pause()'></span>
        <span class='glyphicon glyphicon-play' onclick='play(counter)'></span>
        <span class='glyphicon glyphicon-forward' onclick='slowDown()' ></span>
        <span class='glyphicon glyphicon-fast-forward' onclick='speedUp()'></span>
      </div>
    </div>

  </body>
</html>